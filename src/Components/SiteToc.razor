@using Blake.Types
@using BlakePlugin.DocsRenderer.Types

<nav id="course-toc" class="course-toc nav flex-column">
    @foreach (var module in Modules)
    {
        <div class="module">
            <a class="nav-link module-title" href="#" data-bs-toggle="collapse" data-bs-target="#module-@module.Id">
                <i class="fas fa-chevron-@(module.Id == ActivePageId ? "down" : "right") me-2"></i>@module.Text
            </a>
            <div id="module-@module.Id" class="collapse @(module.Id == ActivePageId ? "show" : "") ps-2">
                <nav class="nav flex-column module-pages">
                    @foreach (var chapter in module.Children)
                    {
                        <a class="nav-link @(chapter.Id == Model.ActiveChapter ? "active" : "")" href="/Content/CourseContent?pageId=@chapter.Id" data-page-id="@chapter.Id">@chapter.Text</a>
                    }
                </nav>
            </div>
        </div>
    }
</nav>

@code {

        [Parameter]
        public List<PageModel> Content { get; set; } = [];

        [Parameter]
        public string? ActivePage { get; set; }

        [Parameter]
        public string? ActiveSlug { get; set; }

    protected override void OnParametersSet()
    {
        if (string.IsNullOrEmpty(ActivePage) && string.IsNullOrEmpty(ActiveSlug))
        {
            throw new InvalidOperationException("SiteToc requires either ActivePage or ActiveSlug.");
        }
    }

    public class TocNode : Section
    {
        public required string Slug { get; set; }

        public new List<TocNode> Children { get; set; } = new();
    }


    public static List<TocNode> BuildSiteTocNodes(List<PageModel> pages)
    {
        var root = new TocNode
        {
            Id = "root",
            Text = "Root",
            Slug = "/",
            Children = []
        };

        foreach (var page in pages.OrderBy(p => p.Slug))
        {
            var slugParts = page.Slug.Trim('/').Split('/');
            var current = root;

            for (int i = 0; i < slugParts.Length; i++)
            {
                var segment = slugParts[i];
                var isLeaf = i == slugParts.Length - 1;
                var slugPath = "/" + string.Join('/', slugParts.Take(i + 1));

                var child = current.Children.FirstOrDefault(c => c.Id == segment);
                if (child == null)
                {
                    child = new TocNode
                    {
                        Id = segment,
                        Text = isLeaf ? page.Title : segment,
                        Slug = slugPath,
                        Children = []
                    };
                    current.Children.Add(child);
                }

                current = child;
            }
        }

        return root.Children;
    }

}